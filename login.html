<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>المصادقة - Smart Dorm Expenses</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyA2GNsXj4DzWyCYLKuVT3i1XBKfjX3ccuM",
            authDomain: "siu-students.firebaseapp.com",
            databaseURL: "https://siu-students-default-rtdb.firebaseio.com",
            projectId: "siu-students",
            storageBucket: "siu-students.firebasestorage.app",
            messagingSenderId: "76007314543",
            appId: "1:76007314543:web:4850b668cec4b93bdc699a",
            measurementId: "G-SB6884R2FX"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            sendEmailVerification,
            updateProfile,
            sendPasswordResetEmail // تم إضافة دالة استعادة كلمة المرور
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // تصدير الدوال للنطاق العالمي
        window.auth = auth;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.sendEmailVerification = sendEmailVerification;
        window.updateProfile = updateProfile;
        window.sendPasswordResetEmail = sendPasswordResetEmail; 
        window.db = db;
        window.ref = ref;
        window.set = set;
        window.get = get;     
        window.child = child; 
    </script>

    <style>
        body { background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .auth-card { background: white; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); padding: 40px; max-width: 400px; width: 90%; }
        .input-group input { width: 100%; padding: 15px; border: 2px solid #E5E7EB; border-radius: 12px; transition: all 0.3s ease; }
        .btn-auth { color: white; padding: 15px; border-radius: 12px; font-weight: 700; width: 100%; cursor: pointer; transition: all 0.3s ease; }
        .btn-signup { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .btn-login { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .error-message { color: #EF4444; background-color: #FEE2E2; padding: 10px; border-radius: 8px; margin-top: 15px; text-align: center; display: none; }
    </style>
</head>
<body>
    <div class="auth-card">
        <h1 id="authTitle" class="text-3xl font-bold text-center text-gray-800 mb-2">
            <i class="fas fa-user-plus text-blue-500"></i> إنشاء حساب
        </h1>
        <p id="authSubtitle" class="text-center text-gray-500 mb-8">الرجاء إدخال بياناتك للمتابعة.</p>

        <div id="errorMessage" class="error-message"></div>

        <div id="nameGroup" class="input-group mb-6">
            <label for="name" class="block font-medium text-gray-700 mb-2">الاسم كاملاً</label>
            <input type="text" id="name" placeholder="مثال: خالد محمد">
        </div>

        <div class="input-group mb-6">
            <label for="email" class="block font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
            <input type="email" id="email" placeholder="example@domain.com">
        </div>

        <div class="input-group mb-6">
            <label for="password" class="block font-medium text-gray-700 mb-2">كلمة المرور</label>
            <input type="password" id="password" placeholder="********">
        </div>

        <div id="confirmPasswordGroup" class="input-group mb-4">
            <label for="confirmPassword" class="block font-medium text-gray-700 mb-2">تأكيد كلمة المرور</label>
            <input type="password" id="confirmPassword" placeholder="********">
        </div>

        <div id="forgotPasswordContainer" class="text-left mb-6" style="display:none;">
            <a href="#" onclick="handleForgotPassword()" class="text-sm text-blue-500 hover:underline">نسيت كلمة المرور؟</a>
        </div>

        <button id="signupButton" onclick="handleSignup()" class="btn-auth btn-signup mb-4">
            <i class="fas fa-user-plus"></i> إنشاء الحساب
        </button>
        <button id="loginButton" onclick="handleLogin()" class="btn-auth btn-login" style="display:none;">
            <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
        </button>

        <p class="text-center text-gray-500 mt-4">
            <span id="toggleText">هل لديك حساب بالفعل؟</span>
            <a href="#" id="toggleLink" onclick="toggleForm()" class="text-blue-600 hover:text-blue-800 font-medium">سجّل الدخول</a>
        </p>
    </div>

    <script>
        let isSignup = true;

        function displayError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorMessage.style.display = 'block';
        }

        function clearError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function toggleForm() {
            isSignup = !isSignup;
            clearError();

            document.getElementById('authTitle').innerHTML = isSignup ? '<i class="fas fa-user-plus text-blue-500"></i> إنشاء حساب' : '<i class="fas fa-sign-in-alt text-blue-500"></i> تسجيل الدخول';
            document.getElementById('authSubtitle').textContent = isSignup ? 'الرجاء إدخال بياناتك لإنشاء حساب.' : 'الرجاء إدخال بريدك الإلكتروني وكلمة المرور لتسجيل الدخول.';

            document.getElementById('signupButton').style.display = isSignup ? 'block' : 'none';
            document.getElementById('loginButton').style.display = isSignup ? 'none' : 'block';
            document.getElementById('confirmPasswordGroup').style.display = isSignup ? 'block' : 'none';
            document.getElementById('nameGroup').style.display = isSignup ? 'block' : 'none';
            
            // إظهار/إخفاء رابط نسيت كلمة المرور
            document.getElementById('forgotPasswordContainer').style.display = isSignup ? 'none' : 'block';

            document.getElementById('toggleText').textContent = isSignup ? 'هل لديك حساب بالفعل؟' : 'ليس لديك حساب؟';
            document.getElementById('toggleLink').textContent = isSignup ? 'سجّل الدخول' : 'أنشئ حساباً';
        }

        // دالة التعامل مع الأخطاء الشاملة
        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return 'عذراً، هذا الحساب غير مسجل لدينا.';
                case 'auth/wrong-password':
                    return 'كلمة المرور التي أدخلتها غير صحيحة.';
                case 'auth/email-already-in-use':
                    return 'هذا البريد الإلكتروني مسجل بالفعل لمستخدم آخر.';
                case 'auth/invalid-email':
                    return 'صيغة البريد الإلكتروني غير صحيحة.';
                case 'auth/weak-password':
                    return 'كلمة المرور ضعيفة جداً، يجب أن تكون 6 خانات على الأقل.';
                case 'auth/network-request-failed':
                    return 'فشل الاتصال بالشبكة، تأكد من اتصالك بالإنترنت.';
                case 'auth/too-many-requests':
                    return 'تم حظر المحاولات مؤقتاً بسبب كثرة الطلبات. حاول لاحقاً.';
                case 'auth/user-disabled':
                    return 'هذا الحساب تم تعطيله من قبل الإدارة.';
                default:
                    return 'حدث خطأ ما: ' + errorCode;
            }
        }

        async function handleSignup() {
            clearError();
            const name = document.getElementById('name').value.trim(); 
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            if (!name || !email || !password) {
                displayError('يرجى ملء جميع الحقول المطلوبة.');
                return;
            }

            if (password !== confirmPassword) {
                displayError('كلمة المرور وتأكيد كلمة المرور غير متطابقان.');
                return;
            }

            try {
                const dbRef = window.ref(window.db);
                const snapshot = await window.get(window.child(dbRef, `users`));

                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const nameExists = Object.values(users).some(user => 
                        user.displayName && user.displayName.toLowerCase() === name.toLowerCase()
                    );

                    if (nameExists) {
                        displayError('هذا الاسم مُسجّل بالفعل. يرجى اختيار اسم آخر.');
                        return; 
                    }
                }

                const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;

                await window.updateProfile(user, { displayName: name });
                await window.sendEmailVerification(user);
                
                const userRef = window.ref(window.db, 'users/' + user.uid);
                await window.set(userRef, { displayName: name, balance: 0.00 });

                alert('تهانينا! تم إنشاء حسابك. يرجى التحقق من بريدك الإلكتروني لتفعيل الحساب.');
                toggleForm();

            } catch (error) {
                displayError(getAuthErrorMessage(error.code));
            }
        }

        async function handleLogin() {
            clearError();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!email || !password) {
                displayError('يرجى إدخال البريد الإلكتروني وكلمة المرور.');
                return;
            }

            window.signInWithEmailAndPassword(window.auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    user.reload().then(() => {
                        if (user.emailVerified) {
                            alert('تم تسجيل الدخول بنجاح! مرحباً بك.');
                            window.location.href = 'index.html'; 
                        } else {
                            window.auth.signOut();
                            displayError('بريدك الإلكتروني غير موثق. يرجى تفعيل الحساب من رسالة التحقق.');
                        }
                    });
                })
                .catch((error) => {
                    displayError(getAuthErrorMessage(error.code));
                });
        }

        async function handleForgotPassword() {
            const email = document.getElementById('email').value.trim();
            if (!email) {
                displayError('يرجى كتابة بريدك الإلكتروني أولاً في الخانة المخصصة لإرسال رابط استعادة كلمة المرور.');
                return;
            }

            window.sendPasswordResetEmail(window.auth, email)
                .then(() => {
                    alert('تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني.');
                })
                .catch((error) => {
                    displayError(getAuthErrorMessage(error.code));
                });
        }

        document.addEventListener('DOMContentLoaded', () => { 
            // تأكد من ضبط الواجهة على وضع التسجيل عند التحميل
            isSignup = false; 
            toggleForm(); 
        });
    </script>
</body>
</html>
 