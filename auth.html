<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - Smart Dorm Expenses</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script type="module">
        // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyA2GNsXj4DzWyCYLKuVT3i1XBKfjX3ccuM",
            authDomain: "siu-students.firebaseapp.com",
            databaseURL: "https://siu-students-default-rtdb.firebaseio.com",
            projectId: "siu-students",
            storageBucket: "siu-students.firebasestorage.app",
            messagingSenderId: "76007314543",
            appId: "1:76007314543:web:4850b668cec4b93bdc699a",
            measurementId: "G-SB6884R2FX"
        };

        // 2. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯ÙˆØ§Ù„ Firebase Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            sendEmailVerification,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        // ğŸ’¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù…
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"; 

        // 3. ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // 4. Ø¯Ù…Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ (Window)
        window.auth = auth;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.sendEmailVerification = sendEmailVerification;
        window.updateProfile = updateProfile;
        window.db = db;
        window.ref = ref;
        window.set = set;
        window.get = get;     
        window.child = child; 
    </script>

    <style>
        body { background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .auth-card { background: white; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); padding: 40px; max-width: 400px; width: 90%; }
        .input-group input { width: 100%; padding: 15px; border: 2px solid #E5E7EB; border-radius: 12px; transition: all 0.3s ease; }
        .btn-auth { color: white; padding: 15px; border-radius: 12px; font-weight: 700; width: 100%; cursor: pointer; transition: all 0.3s ease; }
        .btn-signup { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .btn-login { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .error-message { color: #EF4444; background-color: #FEE2E2; padding: 10px; border-radius: 8px; margin-top: 15px; text-align: center; display: none; }
    </style>
</head>
<body>
    <div class="auth-card">
        <h1 id="authTitle" class="text-3xl font-bold text-center text-gray-800 mb-2">
            <i class="fas fa-user-plus text-blue-500"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
        </h1>
        <p id="authSubtitle" class="text-center text-gray-500 mb-8">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>

        <div id="errorMessage" class="error-message"></div>

        <div id="nameGroup" class="input-group mb-6">
            <label for="name" class="block font-medium text-gray-700 mb-2">Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹</label>
            <input type="text" id="name" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø§Ù„Ø¯ Ù…Ø­Ù…Ø¯" required>
        </div>

        <div class="input-group mb-6">
            <label for="email" class="block font-medium text-gray-700 mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" id="email" placeholder="example@domain.com" required>
        </div>

        <div class="input-group mb-6">
            <label for="password" class="block font-medium text-gray-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="password" placeholder="********" required>
        </div>

        <div id="confirmPasswordGroup" class="input-group mb-8">
            <label for="confirmPassword" class="block font-medium text-gray-700 mb-2">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="confirmPassword" placeholder="********" required>
        </div>

        <button id="signupButton" onclick="handleSignup()" class="btn-auth btn-signup mb-4">
            <i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
        </button>
        <button id="loginButton" onclick="handleLogin()" class="btn-auth btn-login" style="display:none;">
            <i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        </button>

        <p class="text-center text-gray-500 mt-4">
            <span id="toggleText">Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ</span>
            <a href="#" id="toggleLink" onclick="toggleForm()" class="text-blue-600 hover:text-blue-800 font-medium">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        </p>
    </div>

    <script>
        let isSignup = true;

        function displayError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorMessage.style.display = 'block';
        }

        function clearError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function toggleForm() {
            isSignup = !isSignup;
            clearError();

            document.getElementById('authTitle').innerHTML = isSignup ? '<i class="fas fa-user-plus text-blue-500"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨' : '<i class="fas fa-sign-in-alt text-blue-500"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            document.getElementById('authSubtitle').textContent = isSignup ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨.' : 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';

            document.getElementById('signupButton').style.display = isSignup ? 'block' : 'none';
            document.getElementById('loginButton').style.display = isSignup ? 'none' : 'block';
            document.getElementById('confirmPasswordGroup').style.display = isSignup ? 'block' : 'none';
            document.getElementById('nameGroup').style.display = isSignup ? 'block' : 'none';

            document.getElementById('toggleText').textContent = isSignup ? 'Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ' : 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ';
            document.getElementById('toggleLink').textContent = isSignup ? 'Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Ù‹';
        }

        async function handleSignup() {
            clearError();
            const name = document.getElementById('name').value.trim(); 
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            if (password !== confirmPassword) {
                displayError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø§Ù†.');
                return;
            }

            if (!name) {
                displayError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙƒØ§Ù…Ù„Ø§Ù‹.');
                return;
            }

            // ğŸŸ¢ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ­Ø­ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ø³Ù… (ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©)
            try {
                const dbRef = window.ref(window.db);
                // ğŸ’¡ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ù€ get Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± users
                const snapshot = await window.get(window.child(dbRef, `users`));

                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const nameExists = Object.values(users).some(user => 
                        user.displayName && user.displayName.toLowerCase() === name.toLowerCase()
                    );

                    if (nameExists) {
                        displayError('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙØ³Ø¬Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø±.');
                        return; 
                    }
                } 
                // ğŸ’¡ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† (snapshot.exists() = false)ØŒ Ø³Ù†ØªØ§Ø¨Ø¹ Ø¥Ù„Ù‰ Firebase Auth Ø¯ÙˆÙ† Ø¹Ø±Ø¶ Ø®Ø·Ø£.

            } catch (error) {
                // ğŸ›‘ Ù‡Ø°Ø§ ÙŠÙ…Ù†Ø¹ Ø±Ø³Ø§Ù„Ø© "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡" Ù…Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                // Ø¨Ù„ Ø³ÙŠØ³ØªÙ…Ø± ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                console.warn("Could not check for name duplication, proceeding with signup. Error:", error);
            }

            // Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ Firebase Auth
            window.createUserWithEmailAndPassword(window.auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;

                    return window.updateProfile(user, { displayName: name })
                        .then(() => {
                            return window.sendEmailVerification(user);
                        })
                        .then(() => {
                            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                            const userRef = window.ref(window.db, 'users/' + user.uid);
                            return window.set(userRef, {
                                displayName: name,
                                balance: 0.00
                            });
                        });
                })
                .then(() => {
                    alert('ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
                    toggleForm();
                })
                .catch((error) => {
                    let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ÙØ³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹ (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).';
                    }
                    displayError(errorMessage);
                });
        }

        function handleLogin() {
            clearError();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            window.signInWithEmailAndPassword(window.auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;

                    user.reload().then(() => {
                        if (user.emailVerified) {
                            alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ.');
                            window.location.href = 'index.html'; 
                        } else {
                            window.auth.signOut();
                            alert('Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…ÙˆØ«Ù‚. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
                        }
                    });
                })
                .catch((error) => {
                    let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.';
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                    }
                    displayError(errorMessage);
                });
        }

        document.addEventListener('DOMContentLoaded', () => { toggleForm(); });
    </script>
</body>
</html>
