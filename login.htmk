<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>المصادقة - Smart Dorm Expenses</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script type="module">
        // 1. إعدادات Firebase الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyA2GNsXj4DzWyCYLKuVT3i1XBKfjX3ccuM",
            authDomain: "siu-students.firebaseapp.com",
            databaseURL: "https://siu-students-default-rtdb.firebaseio.com",
            projectId: "siu-students",
            storageBucket: "siu-students.firebasestorage.app",
            messagingSenderId: "76007314543",
            appId: "1:76007314543:web:4850b668cec4b93bdc699a",
            measurementId: "G-SB6884R2FX"
        };

        // 2. استيراد دوال Firebase الضرورية
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            sendEmailVerification 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        // 3. تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // 4. دمج الدوال داخل النطاق العالمي (Window) ليتمكن الكود في <script> العادي من الوصول إليها
        window.auth = auth;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.sendEmailVerification = sendEmailVerification;
    </script>

    <style>
        /* أنماط مخصصة */
        body {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auth-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 40px;
            max-width: 400px;
            width: 90%;
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #F9FAFB;
        }
        .input-group input:focus {
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: white;
        }
        .btn-auth {
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        .btn-signup {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); /* برتقالي */
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .btn-login {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%); /* أخضر */
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .btn-auth:hover {
            transform: translateY(-2px);
        }
        .error-message {
            color: #EF4444;
            background-color: #FEE2E2;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            display: none;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="auth-card">
        <h1 id="authTitle" class="text-3xl font-bold text-center text-gray-800 mb-2">
            <i class="fas fa-user-plus text-blue-500"></i> إنشاء حساب
        </h1>
        <p id="authSubtitle" class="text-center text-gray-500 mb-8">الرجاء إدخال بريدك الإلكتروني وكلمة المرور لإنشاء حساب.</p>

        <div id="errorMessage" class="error-message"></div>

        <div class="input-group mb-6">
            <label for="email" class="block font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
            <input type="email" id="email" placeholder="example@domain.com" required>
        </div>

        <div class="input-group mb-6">
            <label for="password" class="block font-medium text-gray-700 mb-2">كلمة المرور</label>
            <input type="password" id="password" placeholder="********" required>
        </div>

        <div id="confirmPasswordGroup" class="input-group mb-8">
            <label for="confirmPassword" class="block font-medium text-gray-700 mb-2">تأكيد كلمة المرور</label>
            <input type="password" id="confirmPassword" placeholder="********" required>
        </div>

        <button id="signupButton" onclick="handleSignup()" class="btn-auth btn-signup mb-4">
            <i class="fas fa-user-plus"></i> إنشاء الحساب
        </button>
        <button id="loginButton" onclick="handleLogin()" class="btn-auth btn-login" style="display:none;">
            <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
        </button>

        <p class="text-center text-gray-500 mt-4">
            <span id="toggleText">هل لديك حساب بالفعل؟</span>
            <a href="#" id="toggleLink" onclick="toggleForm()" class="text-blue-600 hover:text-blue-800 font-medium">سجّل الدخول</a>
        </p>
    </div>

    <script>
        // حالة النموذج الحالية (true = تسجيل، false = دخول)
        let isSignup = true;

        // دوال مساعدة للعرض والخطأ
        function displayError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorMessage.style.display = 'block';
        }

        function clearError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // دالة التبديل بين نموذج التسجيل والدخول
        function toggleForm() {
            isSignup = !isSignup;
            clearError();

            const title = document.getElementById('authTitle');
            const subtitle = document.getElementById('authSubtitle');
            const signupBtn = document.getElementById('signupButton');
            const loginBtn = document.getElementById('loginButton');
            const confirmGroup = document.getElementById('confirmPasswordGroup');
            const toggleText = document.getElementById('toggleText');
            const toggleLink = document.getElementById('toggleLink');

            if (isSignup) {
                // وضع إنشاء حساب
                title.innerHTML = '<i class="fas fa-user-plus text-blue-500"></i> إنشاء حساب';
                subtitle.textContent = 'الرجاء إدخال بريدك الإلكتروني وكلمة المرور لإنشاء حساب.';
                signupBtn.style.display = 'block';
                loginBtn.style.display = 'none';
                confirmGroup.style.display = 'block';
                toggleText.textContent = 'هل لديك حساب بالفعل؟';
                toggleLink.textContent = 'سجّل الدخول';
            } else {
                // وضع تسجيل الدخول
                title.innerHTML = '<i class="fas fa-sign-in-alt text-blue-500"></i> تسجيل الدخول';
                subtitle.textContent = 'الرجاء إدخال بريدك الإلكتروني وكلمة المرور لتسجيل الدخول.';
                signupBtn.style.display = 'none';
                loginBtn.style.display = 'block';
                confirmGroup.style.display = 'none';
                toggleText.textContent = 'ليس لديك حساب؟';
                toggleLink.textContent = 'أنشئ حساباً';
            }
        }

        // 3. دالة إنشاء حساب جديد وتوثيقه (Sign Up)
        function handleSignup() {
            clearError();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            if (password !== confirmPassword) {
                displayError('كلمة المرور وتأكيد كلمة المرور غير متطابقان.');
                return;
            }

            // استخدام دالة Firebase المتاحة في النطاق العالمي
            window.createUserWithEmailAndPassword(window.auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log("تم إنشاء المستخدم بنجاح:", user.uid);

                    // **إرسال بريد التوثيق (Email Verification)**
                    return window.sendEmailVerification(user);
                })
                .then(() => {
                    alert('تهانينا! تم إنشاء حسابك. **يرجى التحقق من بريدك الإلكتروني لتفعيل الحساب** قبل محاولة تسجيل الدخول.');
                    // التبديل إلى نموذج تسجيل الدخول بعد النجاح
                    toggleForm();
                })
                .catch((error) => {
                    let errorMessage = 'حدث خطأ غير معروف.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'هذا البريد الإلكتروني مُستخدم بالفعل.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'صيغة البريد الإلكتروني غير صحيحة.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'كلمة المرور ضعيفة جداً (يجب أن تكون 6 أحرف على الأقل).';
                    }
                    displayError(errorMessage);
                });
        }

        // 4. دالة تسجيل الدخول والتحقق من التوثيق (Sign In)
        function handleLogin() {
            clearError();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            // استخدام دالة Firebase المتاحة في النطاق العالمي
            window.signInWithEmailAndPassword(window.auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;

                    // يتم استدعاء 'reload' لضمان الحصول على أحدث حالة للـ emailVerified
                    user.reload().then(() => {
                        if (user.emailVerified) {
                            alert('تم تسجيل الدخول بنجاح! مرحباً بك.');
                            // التوجيه إلى الصفحة الرئيسية
                            // window.location.href = 'dashboard.html';
                        } else {
                            // إذا لم يكن موثقًا، نطلب منه التوثيق
                            window.auth.signOut();
                            alert('بريدك الإلكتروني غير موثق. يرجى التحقق من صندوق الوارد أو البريد المزعج (Spam) وتفعيل الحساب قبل تسجيل الدخول.');
                        }
                    });
                })
                .catch((error) => {
                    let errorMessage = 'حدث خطأ غير معروف.';
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'صيغة البريد الإلكتروني غير صحيحة.';
                    }
                    displayError(errorMessage);
                });
        }

        // التأكد من تهيئة النموذج الافتراضي
        document.addEventListener('DOMContentLoaded', () => {
            toggleForm(); // لتعيين الحالة الافتراضية كـ تسجيل
        });
    </script>
</body>
</html>