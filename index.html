<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ - Smart Dorm Expenses</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* CSS: Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† ØªØµÙ…ÙŠÙ…Ùƒ) */
        body {
            background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 64px;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
        .navbar {
            position: fixed; top: 0; left: 0; right: 0;
            z-index: 900; background-color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            height: 64px;
            padding: 0 16px; 
        }

        /* --- Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) --- */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 250px;
            background: white;
            z-index: 1000;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            padding-top: 64px;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .sidebar.open + .sidebar-overlay {
            display: block;
        }
        .sidebar-link {
            display: block;
            padding: 15px 20px;
            font-weight: 600;
            color: #4B5563;
            transition: background-color 0.3s, color 0.3s;
            border-right: 4px solid transparent;
        }
        .sidebar-link:hover {
            background-color: #F3F4F6;
            color: #3B82F6;
        }
        .sidebar-link.active {
            color: #1D4ED8;
            background-color: #EBF5FF;
            border-right-color: #1D4ED8;
        }

        /* Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù‚Øµ Ø§Ù„Ù†Øµ Ø§Ù„Ø²Ø§Ø¦Ø¯ */
        .sidebar-profile-text {
            white-space: nowrap; 
            overflow: hidden;    
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .content-wrapper {
            flex-grow: 1; display: flex; align-items: flex-start;
            justify-content: center; padding: 20px;
        }
        .container {
            background: white; border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); padding: 40px;
            max-width: 600px; width: 100%; margin-top: 20px; position: relative;
        }

        /* --- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ --- */
        .balance-card {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white; padding: 20px; border-radius: 15px;
            text-align: center; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            transition: background 0.5s ease;
        }
        .balance-card.negative {
            background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%) !important;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }
        .balance-card h3 { font-size: 18px; margin-bottom: 5px; opacity: 0.9; }
        .balance-card p { font-size: 28px; font-weight: 800; letter-spacing: 1px; }

        /* Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .form-group input, .form-group select {
            width: 100%; padding: 15px; border: 2px solid #E5E7EB;
            border-radius: 12px; background: #F9FAFB; font-size: 16px;
        }
        .form-group input:focus, .form-group select:focus { border-color: #3B82F6; background: white; outline: none; }

        /* Checkboxes */
        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .checkbox-item {
            display: flex; align-items: center; background: #F3F4F6;
            padding: 12px 15px; border-radius: 10px; cursor: pointer;
            border: 2px solid transparent; transition: 0.3s;
        }
        .checkbox-item:hover { background: #E5E7EB; border-color: #3B82F6; }
        .checkbox-item input { margin-left: 10px; width: auto; }

        .select-all {
            background: #3B82F6; color: white; padding: 10px;
            border-radius: 10px; cursor: pointer; text-align: center; margin-bottom: 15px;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: white; padding: 15px 30px; border-radius: 12px; font-size: 16px; font-weight: 600;
            width: 100%; display: inline-flex; justify-content: center; align-items: center; gap: 10px;
            border: none; cursor: pointer;
        }
        .btn-secondary { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }

        /* Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…Ø±Ø³Ø§Ù„ */
        .warning { background: #F59E0B; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .messenger-warning { 
            background: #FEF2F2; color: #B91C1C; padding: 15px; border-radius: 8px; margin-bottom: 15px; 
            border: 1px solid #FCA5A5; text-align: right;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        #previewDetails { display: block; }
        #messengerConfirmation { display: none; } 

        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .max-h-96 { max-height: 24rem; }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="max-w-6xl mx-auto px-4 h-full">
            <div class="flex justify-between items-center h-full">

                <button id="menuButton" class="text-2xl text-gray-600 hover:text-blue-500 p-2 focus:outline-none">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="text-2xl font-extrabold text-blue-600 absolute right-1/2 transform translate-x-1/2 hidden sm:block">
                    <i class="fas fa-home"></i> Smart Dorm
                </div>

                <div class="flex items-center">
                    <button id="notificationButton" class="relative text-gray-500 hover:text-red-500 p-2 focus:outline-none" onclick="showNotifications()">
                        <i class="fas fa-bell text-2xl"></i>
                        <span id="notificationBadge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">
                            0 
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div id="sidebar" class="sidebar">
        <div class="p-4 border-b">
            <h3 class="text-lg font-bold text-gray-800 sidebar-profile-text" id="sidebarUserName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
            <p class="text-sm text-gray-500 sidebar-profile-text" id="sidebarUserEmail">...</p>
        </div>
        <a href="index.html" class="sidebar-link active"><i class="fas fa-plus-circle ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</a>
        <a href="my_expenses.html" class="sidebar-link"><i class="fas fa-file-invoice-dollar ml-2"></i> Ù…ØµØ±ÙˆÙØ§ØªÙŠ</a>
        <a href="history.html" class="sidebar-link"><i class="fas fa-history ml-2"></i> Ø§Ù„Ø³Ø¬Ù„</a>
        <a href="summary.html" class="sidebar-link"><i class="fas fa-chart-pie ml-2"></i> Ø§Ù„Ù…Ù„Ø®Øµ ÙˆØ§Ù„ØªØ³ÙˆÙŠØ©</a>
        <a href="auth.html" id="logoutSidebarButton" class="sidebar-link text-red-600 hover:text-red-800 mt-4">
            <i class="fas fa-sign-out-alt ml-2"></i> Ø®Ø±ÙˆØ¬
        </a>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <div class="content-wrapper">
        <div class="container">

            <div class="text-center text-gray-500 text-sm mb-6 italic">
                <i class="fas fa-wallet"></i> Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø³ÙƒÙ† Ø§Ù„Ø°ÙƒÙŠ
            </div>

            <div id="currentBalanceCard" class="balance-card">
                <h3>
                    <i class="fas fa-user-circle ml-1"></i> Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="userNamePlaceholder" class="font-bold underline">...</span>
                </h3>
                <p dir="ltr">
                    <span id="currentBalance">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span> <span class="text-lg font-normal">SDG</span>
                </p>
            </div>

            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">
                Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯
            </h1>

            <form id="expenseForm">
                <div class="form-group">
                    <label for="expenseTitle">Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                    <input type="text" id="expenseTitle" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø´Ø§Ø¡ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡..." list="suggestions" required>
                    <datalist id="suggestions">
                        <option value="Ø£ÙƒÙ„"><option value="Ø´Ø±Ø¨"><option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡"><option value="Ù†Ø¸Ø§ÙØ©">
                    </datalist>
                </div>

                <div class="form-group flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                    <label for="isMessenger" class="text-sm font-semibold text-red-700 select-none cursor-pointer">
                        <i class="fas fa-hand-holding-usd ml-1"></i> Ø¯ÙØ¹Øª ÙƒÙ…ÙØ±Ø³Ø§Ù„ (Ù„Ø³Øª Ù…Ø´Ø§Ø±ÙƒØ§Ù‹)
                    </label>
                    <input type="checkbox" id="isMessenger" class="form-checkbox h-5 w-5 text-red-600">
                </div>

                <div class="form-group">
                    <label for="expenseAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ (SDG)</label>
                    <input type="tel" id="expenseAmount" placeholder="Ù…Ø«Ø§Ù„: 5,000" oninput="formatNumber(this)" required style="direction: ltr; text-align: right;">
                </div>

                <div class="form-group mt-6">
                    <label>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† (Ù…Ù† Ø³ÙŠÙ‚ØªØ³Ù…ÙˆÙ† Ø§Ù„Ù…Ø¨Ù„Øº)</label>
                    <div class="select-all" onclick="selectAllParticipants()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù…ÙŠØ¹</div>
                    <div class="checkbox-group" id="participantsCheckboxes">
                        <div class="text-center text-gray-400 py-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</div>
                    </div>
                </div>

                <button type="button" onclick="previewExpense()" class="btn btn-secondary">
                    Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ­ÙØ¸
                </button>
            </form>
        </div>
    </div>

    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div id="previewDetails">
                <div id="warning" class="warning"><i class="fas fa-exclamation-triangle"></i> ØªØ­Ø°ÙŠØ±: Ù…ØµØ±ÙˆÙ Ù…ÙƒØ±Ø±!</div>
                <h2 class="text-xl font-bold mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØµØ±ÙˆÙ</h2>
                <div id="previewText" class="text-right text-gray-700 mb-6 text-sm leading-loose"></div>
                <div class="flex justify-center gap-4">
                    <button id="mainSaveButton" onclick="handleSaveClick()" class="btn w-auto">Ø­ÙØ¸</button>
                    <button onclick="hideModal()" class="btn w-auto bg-gray-500 text-white">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>

            <div id="messengerConfirmation">
                <div class="messenger-warning">
                    <h3 class="font-extrabold mb-2 text-xl"><i class="fas fa-exclamation-triangle ml-1"></i> ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…: ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø³Ø§Ù„!</h3>
                    <p class="text-base leading-relaxed">
                        Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙƒÙ€ <strong>Ù…ÙØ±Ø³Ø§Ù„</strong>. Ù‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù†Ùƒ Ø¯ÙØ¹Øª Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ù†ÙŠØ§Ø¨Ø© Ø¹Ù† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†ØŒ ÙˆØ­ØµØªÙƒ Ø³ØªÙƒÙˆÙ† <strong>ØµÙØ±Ø§Ù‹</strong>.
                    </p>
                    <p class="mt-2 font-bold">
                        Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙƒÙ€ Ù…ÙØ±Ø³Ø§Ù„ØŸ
                    </p>
                </div>
                <div class="flex justify-center gap-4">
                    <button onclick="saveExpense()" class="btn w-auto bg-red-600 hover:bg-red-700">Ù…ÙˆØ§ÙÙ‚ (ØªØ³Ø¬ÙŠÙ„ ÙƒÙ…Ø±Ø³Ø§Ù„)</button>
                    <button onclick="hideModal()" class="btn w-auto bg-gray-500 text-white">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-green-600 mb-4"><i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„Ø­ÙØ¸!</h2>
            <button onclick="hideSuccessModal()" class="btn w-full">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="notificationModal" class="modal">
        <div class="modal-content max-w-md text-right">
            <h2 class="text-xl font-bold mb-4 border-b pb-2"><i class="fas fa-bell ml-1"></i> Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
            <div id="notificationsList" class="space-y-3 text-sm max-h-96 overflow-y-auto">
            </div>
            <button onclick="hideNotificationModal()" class="btn w-full mt-6 bg-gray-500 text-white">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ğŸ”¥ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentUserData = null;
        let allUsers = {};
        let tempExpenseData = null;

        // Auth Guard - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        onAuthStateChanged(auth, (user) => {
            if (!user || !user.emailVerified) {
                window.location.href = 'auth.html';
                return;
            }
            currentUser = user;
            loadUserData();
            loadUsers();
        });

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        function loadUserData() {
            const userRef = ref(db, 'users/' + currentUser.uid);
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    currentUserData = snapshot.val();
                    updateUI();
                }
            });
        }

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function updateUI() {
            const balance = currentUserData.balance || 0;
            const balanceCard = document.getElementById('currentBalanceCard');
            const balanceEl = document.getElementById('currentBalance');
            
            document.getElementById('userNamePlaceholder').textContent = currentUserData.username;
            document.getElementById('sidebarUserName').textContent = currentUserData.username;
            document.getElementById('sidebarUserEmail').textContent = currentUserData.email;
            
            balanceEl.textContent = balance.toLocaleString('ar-SD');
            
            if (balance < 0) {
                balanceCard.classList.add('negative');
            } else {
                balanceCard.classList.remove('negative');
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
        function loadUsers() {
            const usersRef = ref(db, 'users');
            onValue(usersRef, (snapshot) => {
                allUsers = {};
                const container = document.getElementById('participantsCheckboxes');
                container.innerHTML = '';
                
                snapshot.forEach((child) => {
                    const uid = child.key;
                    const data = child.val();
                    allUsers[uid] = data;
                    
                    if (uid !== currentUser.uid) {
                        const div = document.createElement('div');
                        div.className = 'checkbox-item';
                        div.innerHTML = `
                            <input type="checkbox" id="user_${uid}" value="${uid}" class="participant-checkbox">
                            <label for="user_${uid}" class="cursor-pointer flex-1">${data.username}</label>
                        `;
                        container.appendChild(div);
                    }
                });
            });
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        document.getElementById('logoutSidebarButton').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            window.location.href = 'auth.html';
        });

        // ğŸ”¥ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© (Global Functions) Ù„Ù„ÙˆØµÙˆÙ„ Ù…Ù† HTML
        
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : 'auto';
        };

        window.closeSidebar = function() {
            document.getElementById('sidebar').classList.remove('open');
            document.body.style.overflow = 'auto';
        };

        window.formatNumber = function(input) {
            let value = input.value.replace(/,/g, '');
            if (value) {
                input.value = parseInt(value).toLocaleString('en-US');
            }
        };

        window.selectAllParticipants = function() {
            const checkboxes = document.querySelectorAll('.participant-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        };

        window.previewExpense = function() {
            const title = document.getElementById('expenseTitle').value.trim();
            const amountStr = document.getElementById('expenseAmount').value.replace(/,/g, '');
            const amount = parseFloat(amountStr);
            const isMessenger = document.getElementById('isMessenger').checked;
            
            if (!title || !amount || amount <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØµØ±ÙˆÙ ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                return;
            }

            const checkboxes = document.querySelectorAll('.participant-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø´Ø§Ø±Ùƒ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            const participants = Array.from(checkboxes).map(cb => cb.value);
            const participantNames = participants.map(uid => allUsers[uid]?.username).join('ØŒ ');
            
            let share = amount / (isMessenger ? participants.length : participants.length + 1);
            
            let previewHTML = `
                <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${title}<br>
                <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ:</strong> ${amount.toLocaleString()} SDG<br>
                <strong>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ:</strong> ${isMessenger ? 'Ø¯ÙØ¹ ÙƒÙ…ÙØ±Ø³Ø§Ù„ (Ù„Ø³Øª Ù…Ø´Ø§Ø±ÙƒØ§Ù‹)' : 'Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø§Ø¯ÙŠØ©'}<br>
                <strong>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†:</strong> ${participantNames}<br>
                <strong>Ø§Ù„Ø­ØµØ© Ù„ÙƒÙ„ Ø´Ø®Øµ:</strong> ${share.toFixed(2)} SDG<br>
            `;

            if (!isMessenger) {
                previewHTML += `<strong>Ø­ØµØªÙƒ:</strong> ${share.toFixed(2)} SDG<br>`;
            }

            document.getElementById('previewText').innerHTML = previewHTML;
            
            tempExpenseData = {
                title: title,
                amount: amount,
                isMessenger: isMessenger,
                participants: participants
            };

            if (isMessenger) {
                document.getElementById('previewDetails').style.display = 'none';
                document.getElementById('messengerConfirmation').style.display = 'block';
            } else {
                document.getElementById('previewDetails').style.display = 'block';
                document.getElementById('messengerConfirmation').style.display = 'none';
            }

            document.getElementById('previewModal').classList.add('show');
        };

        window.handleSaveClick = function() {
            saveExpense();
        };

        window.saveExpense = async function() {
            if (!tempExpenseData) return;

            const { title, amount, isMessenger, participants } = tempExpenseData;
            
            try {
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                const updates = {};
                const share = amount / (isMessenger ? participants.length : participants.length + 1);
                
                // Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
                participants.forEach(uid => {
                    const currentBalance = allUsers[uid].balance || 0;
                    updates[`users/${uid}/balance`] = currentBalance - share;
                });

                // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø¯Ø§ÙØ¹
                const payerBalance = currentUserData.balance || 0;
                if (isMessenger) {
                    // ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø³Ø§Ù„: ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØ§Ù…Ù„Ø§Ù‹
                    updates[`users/${currentUser.uid}/balance`] = payerBalance + amount;
                } else {
                    // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ: ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ (Ø§Ù„Ù…Ø¨Ù„Øº - Ø­ØµØªÙ‡)
                    updates[`users/${currentUser.uid}/balance`] = payerBalance + (amount - share);
                }

                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                await update(ref(db), updates);

                // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ
                const expenseRef = push(ref(db, 'expenses'));
                const expenseData = {
                    title: title,
                    amount: amount,
                    payer_id: currentUser.uid,
                    timestamp: Date.now(),
                    type: isMessenger ? 'MESSENGER' : 'NORMAL',
                    participants: {}
                };

                if (isMessenger) {
                    participants.forEach(uid => expenseData.participants[uid] = true);
                } else {
                    expenseData.participants[currentUser.uid] = true;
                    participants.forEach(uid => expenseData.participants[uid] = true);
                }

                await set(expenseRef, expenseData);

                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                hideModal();
                hideSuccessModal();
                document.getElementById('expenseForm').reset();
                document.getElementById('participantsCheckboxes').innerHTML = '<div class="text-center text-gray-400 py-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</div>';
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø¬Ø§Ø­
                document.getElementById('successModal').classList.add('show');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                loadUsers();
                
            } catch (error) {
                console.error(error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + error.message);
            }
        };

        window.hideModal = function() {
            document.getElementById('previewModal').classList.remove('show');
            tempExpenseData = null;
        };

        window.hideSuccessModal = function() {
            document.getElementById('successModal').classList.remove('show');
        };

        // Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Placeholder)
        window.showNotifications = function() {
            document.getElementById('notificationModal').classList.add('show');
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§
            document.getElementById('notificationsList').innerHTML = '<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>';
        };

        window.hideNotificationModal = function() {
            document.getElementById('notificationModal').classList.remove('show');
        };

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        document.getElementById('menuButton').addEventListener('click', window.toggleSidebar);
    </script>
</body>
</html>
